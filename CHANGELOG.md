# 任務優先級調度器改進日誌

## 版本 1.2 - 2026-01-16

### 主要改進：任務碰撞檢測和位置分配系統

#### 🎯 改進概述
實現了精確的任務位置計算和碰撞檢測系統，確保任務文字之間完全不重疊，並在每次添加/編輯/刪除任務時自動重新排列。

#### ✨ 新功能

1. **精確的文字寬度測量**
   - 使用 Canvas API 精確測量文字實際寬度
   - 根據不同緊急度（urgency 1-4）動態調整字體大小測量
   - 考慮 padding 和安全邊距，確保視覺上的完整性

2. **矩形碰撞檢測（AABB算法）**
   - 替換舊的簡單距離計算方法
   - 使用軸對齊邊界框（Axis-Aligned Bounding Box）算法
   - 精確檢測任務之間的重疊，包括邊界情況

3. **改進的位置分配算法**
   - 增加螺旋擴散因子，更好地分散任務
   - 提高嘗試次數從 100 次到 500 次
   - 動態調整螺旋角度和半徑，避免聚集
   - 智能邊界約束，確保任務不超出容器範圍

4. **自動重新排列機制**
   - 新增任務時：自動重新計算所有任務位置
   - 編輯任務時：更新任務屬性後重新排列
   - 刪除任務時：剩餘任務自動重新分配位置
   - 頁面加載時：根據當前任務集自動排列

#### 🔧 技術細節

**文字測量系統** (`measureTextWidth` 方法)
```javascript
- 創建隱藏的 Canvas 上下文
- 根據 urgency 設置對應字體大小：
  * urgency 4 (Today): 3rem = 48px
  * urgency 3 (in 7 days): 2.4rem = 38.4px
  * urgency 2 (in 21 days): 1.8rem = 28.8px
  * urgency 1 (1 month): 1.4rem = 22.4px
- 返回精確的像素寬度
```

**任務尺寸計算** (`getTaskDimensions` 方法)
```javascript
- 實際文字寬度 + 16px padding + 30px 安全邊距
- 固定高度：80px（包含所有邊距）
- 確保視覺上的清晰分隔
```

**螺旋分配算法** (`calculatePositions` 方法)
```javascript
- 最緊急任務（urgency = 4）放置在中心
- 其他任務按緊急度降序從中心螺旋向外
- 黃金角（137.5°）+ 動態微調（attempts * 5°）
- 基礎半徑：80px
- 螺旋步長：index * 50 * 1.5 + attempts * 3
```

**AABB 碰撞檢測** (`checkOverlap` 方法)
```javascript
- 計算新任務的邊界框：left, right, top, bottom
- 遍歷所有已放置任務的邊界框
- 檢查四個方向的分離軸：
  * 左/右分離：newRight < usedLeft || newLeft > usedRight
  * 上/下分離：newBottom < usedTop || newTop > usedBottom
- 只要有一個軸分離，則無重疊
```

#### 📊 性能優化

- 嘗試次數上限：500 次（從 100 次提升）
- 失敗策略：超過上限時強制放置並輸出警告
- Canvas 復用：在 constructor 中創建，避免重複創建

#### 🎨 用戶體驗改進

- **完全無重疊**：任何情況下任務文字都不會重疊
- **智能排列**：根據緊急度優先級分配最佳位置
- **動態響應**：任務變化時自動重新計算最優排列
- **視覺平衡**：螺旋算法確保視覺上的美觀分布

#### 🔍 調試支持

- 控制台警告：當無法找到完全無重疊位置時輸出警告
- 包含任務標題，方便識別問題任務

#### 📝 代碼變更摘要

**新增方法：**
- `measureTextWidth(text, urgency)` - 精確測量文字寬度
- `getTaskDimensions(task)` - 計算任務實際尺寸

**修改方法：**
- `constructor()` - 添加 Canvas 測量上下文
- `calculatePositions(tasks)` - 完全重寫位置計算邏輯
- `checkOverlap(newPosition, usedPositions)` - 替換為 AABB 算法

**保持不變：**
- 所有 UI 交互邏輯
- 數據存儲結構
- CSS 樣式系統
- 導航和面包屑功能

#### ✅ 測試驗證

建議測試場景：
1. 添加 10+ 個任務，驗證無重疊
2. 混合不同 urgency（1-4）的任務
3. 使用長標題和短標題任務
4. 編輯任務緊急度，觀察重新排列
5. 刪除中間任務，檢查剩餘任務重排
6. 窗口大小調整（響應式測試）

#### 🚀 未來改進建議

- [ ] 添加動畫過渡效果（任務位置變化時）
- [ ] 可選的調試模式（顯示邊界框）
- [ ] 自適應容器大小調整
- [ ] 考慮任務重要度（importance）的視覺權重
- [ ] 持久化任務位置（可選）

---

## 技術架構

### 排列規則優先級
1. **緊急度優先**：urgency 4 → 3 → 2 → 1
2. **中心向外**：最緊急任務佔據中心位置
3. **黃金角螺旋**：視覺上最優的分布方式
4. **無重疊保證**：使用 AABB 精確檢測

### 算法複雜度
- 時間複雜度：O(n² * m)，n = 任務數量，m = 平均嘗試次數
- 空間複雜度：O(n)
- 最壞情況：500 * n 次碰撞檢測

### 瀏覽器兼容性
- Canvas API：所有現代瀏覽器
- Array.sort()：ES5+
- Arrow functions：ES6+
- Template literals：ES6+

---

**作者**: Claude Code
**日期**: 2026-01-16
**版本**: 1.2.0
